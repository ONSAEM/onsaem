<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout3}">

<head>
	<meta charset="UTF-8">
	<!-- Css  -->
	<th:block layout:fragment="css">
		<link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
		<link rel="stylesheet" th:href="@{/shoptemplate/css/nice-select.css}" type="text/css">
		<link rel="stylesheet" th:href="@{/shoptemplate/css/shop/css/jquery-ui.min.css}" type="text/css">
		<link rel="stylesheet" th:href="@{/shoptemplate/css/owl.carousel.min.css}" type="text/css">
		<link rel="stylesheet" th:href="@{/shoptemplate/css/slicknav.min.css}" type="text/css">
		<link rel="stylesheet" th:href="@{/shoptemplate/css/style.css}" type="text/css">
		<link rel="stylesheet" th:href="@{/css/modal.css}" type="text/css">
		<link rel="stylesheet" th:href="@{/css/calendar.css}" type="text/css">
	</th:block>
	<style>
		#addClassInfo .modal-dialog {
			width: 700px;
			margin-bottom: auto;
			margin-top: auto;
		}

		#addClassInfo .inputfield {
			margin-bottom: 15px;
			display: flow-root;
		}

		#addClassInfo .inputfield p {
			margin: 0px;
		}

		#addClassInfo form {
			width: 90%;
			margin: auto;
		}

		#addClassInfo .inputfield label {
			width: 100%;
			color: #629b9b;
			font-size: 15px;
			margin-bottom: 5px;
			font-weight: bold;
			margin-right: 4%;
		}

		#addClassInfo .inputfield .input {
			width: 100%;
			outline: none;
			border: 1px solid #d5dbd9;
			font-size: 15px;
			padding: 8px 10px;
			border-radius: 3px;
			transition: all 0.3s ease;
		}

		#addClassInfo .insertClassInfo {
			background-color: #a5c5c5;
			color: white;
			padding: 5px 10px;
			border-radius: 10px;
			cursor: pointer;
			float: right;
			margin-top: 10px;
		}

		#addClass .modal-dialog {
			width: 600px;
		}

		#addClass .modal-dialog {
			width: 570px;
		}

		#addClass .classTable {
			height: 200px;
			width: 100%;
			text-align: center;
			margin-top: 45px;
		}

		#addClass table {
			width: 248px;
			text-align: center;
		}

		#addClass .classTable tr {
			height: 35px;
		}

		#addClass .classTable th {
			color: #ffffff;
			background-color: #5f9999;
			width: 50%;
		}

		.selectedClass {
			background-color: #9dc2c0;
		}

		#addClass label {
			width: 80px;
			text-align: center;
		}

		#addClass input {
			text-align: end;
			width: 150px;
		}

		#addClass .dayClass input {
			text-align: end;
			width: 110px !important
		}

		#addClass .inputfield button {
			background-color: #a5c5c5;
			color: white;
			padding: 5px 10px;
			border-radius: 10px;
			cursor: pointer;
			float: right;
			margin-top: 10px;
		}

		#addClass .addTime {
			margin-bottom: 10px;
		}

		.addClassInfo {
			background-color: #a5c5c5;
			color: white;
			padding: 5px 10px;
			border-radius: 10px;
			cursor: pointer;
		}

		.addClassInfo:hover {
			background-color: #5f9999;
		}

		.tableView .addClass {
			background-color: #a5c5c5;
			color: white;
			padding: 5px 10px;
			border-radius: 10px;
			cursor: pointer;
		}

		.tableView .addClass:hover {
			background-color: #5f9999;
		}
	</style>
	<link type="text/css" rel="stylesheet" th:href="@{/css/aksFileUpload.min.css}">
	<script th:src="@{/js/fileupload.js}"></script>
	<script type="text/javascript" th:src="@{/smarteditor/js/HuskyEZCreator.js}"></script>
</head>

<body>
	<div layout:fragment="content" class="app-content">
		<div class="app-content-header">
			<h1 class="app-content-headerText">클래스관리</h1>
			<button class="app-content-headerButton addClassInfo">클래스 추가</button>
		</div>
		<div class="app-content-actions">

		</div>
		<div class="products-area-wrapper tableView">
			<div class="products-header">
				<div class="product-cell image">
					클래스
					<button class="sort-button">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M496.1 138.3L375.7 17.9c-7.9-7.9-20.6-7.9-28.5 0L226.9 138.3c-7.9 7.9-7.9 20.6 0 28.5 7.9 7.9 20.6 7.9 28.5 0l85.7-85.7v352.8c0 11.3 9.1 20.4 20.4 20.4 11.3 0 20.4-9.1 20.4-20.4V81.1l85.7 85.7c7.9 7.9 20.6 7.9 28.5 0 7.9-7.8 7.9-20.6 0-28.5zM287.1 347.2c-7.9-7.9-20.6-7.9-28.5 0l-85.7 85.7V80.1c0-11.3-9.1-20.4-20.4-20.4-11.3 0-20.4 9.1-20.4 20.4v352.8l-85.7-85.7c-7.9-7.9-20.6-7.9-28.5 0-7.9 7.9-7.9 20.6 0 28.5l120.4 120.4c7.9 7.9 20.6 7.9 28.5 0l120.4-120.4c7.8-7.9 7.8-20.7-.1-28.5z" />
						</svg>
					</button>
				</div>
				<div class="product-cell category">
					클래스ID
					<button class="sort-button">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M496.1 138.3L375.7 17.9c-7.9-7.9-20.6-7.9-28.5 0L226.9 138.3c-7.9 7.9-7.9 20.6 0 28.5 7.9 7.9 20.6 7.9 28.5 0l85.7-85.7v352.8c0 11.3 9.1 20.4 20.4 20.4 11.3 0 20.4-9.1 20.4-20.4V81.1l85.7 85.7c7.9 7.9 20.6 7.9 28.5 0 7.9-7.8 7.9-20.6 0-28.5zM287.1 347.2c-7.9-7.9-20.6-7.9-28.5 0l-85.7 85.7V80.1c0-11.3-9.1-20.4-20.4-20.4-11.3 0-20.4 9.1-20.4 20.4v352.8l-85.7-85.7c-7.9-7.9-20.6-7.9-28.5 0-7.9 7.9-7.9 20.6 0 28.5l120.4 120.4c7.9 7.9 20.6 7.9 28.5 0l120.4-120.4c7.8-7.9 7.8-20.7-.1-28.5z" />
						</svg>
					</button>
				</div>
				<div class="product-cell sales">
					등록일자
					<button class="sort-button">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M496.1 138.3L375.7 17.9c-7.9-7.9-20.6-7.9-28.5 0L226.9 138.3c-7.9 7.9-7.9 20.6 0 28.5 7.9 7.9 20.6 7.9 28.5 0l85.7-85.7v352.8c0 11.3 9.1 20.4 20.4 20.4 11.3 0 20.4-9.1 20.4-20.4V81.1l85.7 85.7c7.9 7.9 20.6 7.9 28.5 0 7.9-7.8 7.9-20.6 0-28.5zM287.1 347.2c-7.9-7.9-20.6-7.9-28.5 0l-85.7 85.7V80.1c0-11.3-9.1-20.4-20.4-20.4-11.3 0-20.4 9.1-20.4 20.4v352.8l-85.7-85.7c-7.9-7.9-20.6-7.9-28.5 0-7.9 7.9-7.9 20.6 0 28.5l120.4 120.4c7.9 7.9 20.6 7.9 28.5 0l120.4-120.4c7.8-7.9 7.8-20.7-.1-28.5z" />
						</svg>
					</button>
				</div>
				<div class="product-cell status-cell">
					클래스상태
					<button class="sort-button">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 512 512">
							<path fill="currentColor"
								d="M496.1 138.3L375.7 17.9c-7.9-7.9-20.6-7.9-28.5 0L226.9 138.3c-7.9 7.9-7.9 20.6 0 28.5 7.9 7.9 20.6 7.9 28.5 0l85.7-85.7v352.8c0 11.3 9.1 20.4 20.4 20.4 11.3 0 20.4-9.1 20.4-20.4V81.1l85.7 85.7c7.9 7.9 20.6 7.9 28.5 0 7.9-7.8 7.9-20.6 0-28.5zM287.1 347.2c-7.9-7.9-20.6-7.9-28.5 0l-85.7 85.7V80.1c0-11.3-9.1-20.4-20.4-20.4-11.3 0-20.4 9.1-20.4 20.4v352.8l-85.7-85.7c-7.9-7.9-20.6-7.9-28.5 0-7.9 7.9-7.9 20.6 0 28.5l120.4 120.4c7.9 7.9 20.6 7.9 28.5 0l120.4-120.4c7.8-7.9 7.8-20.7-.1-28.5z" />
						</svg>
					</button>
				</div>
				<div class="product-cell status-cell">

				</div>
			</div>
			<div class="products-row" th:each="class : ${classList}" th:id="${class.classId}">
				<div class="product-cell image">
					<img th:src="'/fileView/'+${class.media.fileRoute}" alt="product">
					<span th:text="${class.className}"></span>
				</div>
				<div class="product-cell category">
					<span class="cell-label">클래스ID:</span>[[${class.classId}]]
				</div>
				<div class="product-cell sales">
					<span class="cell-label">등록일자:</span>[[${#dates.format(class.classDate,
					'yyyy년 MM월 dd일')}]]
				</div>
				<div class="product-cell status-cell">
					<span class="cell-label">클래스상태:</span><span class="status active">[[${class.status}]]</span>
				</div>
				<div class="product-cell">
					<button type="button" class="btn addClass">시간추가</button>
				</div>
			</div>
		</div>
		<div class="modal fade" id="addClassInfo" data-bs-keyboard="false" aria-hidden="true" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="modal-wrapper">
							<div class="title">클래스등록</div>
							<form name="classFrm" class="form">
								<div class="inputfield">
									<label>클래스이름</label><br> <input type="text" name="className" class="input">
								</div>
								<div class="inputfield">
									<label>가격</label><br> <input type="number" value="0" min="0" name="price"
										class="input">
								</div>
								<div class="inputfield">
									<label>인원</label><br> <input type="number" value="0" min="0" name="totalPeople"
										class="input">
								</div>
								<div class="inputfield">
									<label>소요시간</label><br> <input type="number" value="1" min="1" name="classTime"
										class="input">
								</div>
								<div class="inputfield">
									<label>난이도</label> <br>
									<div class="custom_select">
										<select name="difficulty">
											<option value="">::난이도::</option>
											<option value="상">상</option>
											<option value="중">중</option>
											<option value="하">하</option>
										</select>
									</div>
								</div>
								<div class="inputfield">
									<label>클래스 설명</label><br>
									<textarea name="explanation" id="ir1" rows="10" cols="99"
										maxlength="1000"></textarea>
								</div>
								<div class="inputfield">
									<label>인증사진</label>
									<p>*클래스 사진을 최소 4장 최대 10장내로 등록해주세요</p>
								</div>
								<div class="inputfiles">
									<input name="classFile" type="file" style="display: none;" multiple>
									<div id="aks-file-upload"></div>
								</div>
								<div class="inputfield">
									<button type="button" class="btn insertClassInfo">등록</button>
								</div>
							</form>
						</div>
					</div>
					<div class="modal-footer"></div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="addClass" data-bs-keyboard="false" aria-hidden="true" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<div class="modal-wrapper">
							<div class="title">클래스 시간 등록</div>
							<div id="calendar" style="float: left;"></div>
							<div style="float: right;">
								<div class="inputfield">
									<button type="button" class="btn addTime">시간추가</button>
								</div>
								<div class="classTable">
									<table>
										<thead>
											<tr>
												<th>시간</th>
											</tr>
										</thead>
										<tbody>

										</tbody>
									</table>
								</div>
								<div class="inputfield">
									<button type="button" class="btn insertClass">예약</button>
								</div>
							</div>
						</div>
					</div>
					<div class="modal-footer"></div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			let token = $("meta[name='_csrf']").attr("content");
			let header = $("meta[name='_csrf_header']").attr("content");
			let applyFileList = [];
			let groupId = '';
			let DateList = [];
			let oEditors = [];
			let selectList = [];

			smartEditor = function () {
				nhn.husky.EZCreator.createInIFrame({
					oAppRef: oEditors,
					elPlaceHolder: "ir1",
					sSkinURI: "/smarteditor/SmartEditor2Skin.html",
					fCreator: "createSEditor2"
				});
			}

			function editer(fileUrl) {
				oEditors.getById["ir1"].exec("PASTE_HTML", [`<video src='${fileUrl}' controls></video>`]);
			}

			$('.addClassInfo').on('click', function () {
				$('#addClassInfo').modal("show");
				$('#addClassInfo').find('iframe').remove();
				smartEditor();
			})

			$("#aks-file-upload").aksFileUpload({
				fileUpload: "#uploadfile", // With target [input]file or [type]json you can save the data of loaded items
				fileType: ["pdf", "docx", "rtf", "jpg", "jpeg", "png"], // allowed file formats
				dragDrop: true, // drag & drop upload
				maxSize: "90 GB", // maximum uploaded file size
				multiple: true, // multiple file upload
				maxFile: 10, // maximum number of uploaded files
				maxFileError: "10개를 넘길 수 없습니다", // error text
				maxSizeError: "File exceeds size. - Max limit:", // error text
				fileTypeError: "Disallowed file format.", // error text
				label: "클릭하거나 파일을 올려주세요" // label text
			});

			//이미지목록에서 삭제하면 input file도 삭제
			function delfileList(fileName) {
				for (let i = 0; i < applyFileList.length; i++) {
					if (applyFileList[i].name == fileName) {
						applyFileList.splice(i, 1);
					}
				}
				$('#aks-file-upload').find('input#aksfileupload').val("");
			}

			//img 비교해서 이미 표시된 이미지면 표시안함
			function matchfile(fileName) {
				let check = true;
				if (applyFileList.length == 0) {
					listinput(fileName);
					return check;
				} else {
					for (let i = 0; i < applyFileList.length; i++) {
						if (applyFileList[i].name == fileName) {
							check = false;
						}
					}
				}
				if (check) {
					listinput(fileName);
				}
				return check;
			}

			// 중복되지 않는 파일은 저장
			function listinput(fileName) {
				let files = $('#aks-file-upload').find('input#aksfileupload')[0].files;
				let fileArray = Array.from(files);
				for (let i = 0; i < fileArray.length; i++) {
					if (fileArray[i].name == fileName) {
						applyFileList.push(fileArray[i]);
					}
				}
				return;
			}

			// 이미지 갯수 확인
			function fileCount(inputCount) {
				if ($('input[name=classFile]').parentsUntil('.form').prev().prop('tagName') == 'P') {
					$('input[name=classFile]').parentsUntil('.form').prev().remove();
				}
				let check = true;
				if (applyFileList.length + inputCount > 10) {
					$('input[name=classFile]').parentsUntil('.form').before($('<p/>').text("사진은 최대 10장까지 등록가능합니다").css(
						"text-align", "center").css("color", "#f20000"));
					check = false;
				} else if (applyFileList.length + inputCount < 4) {
					$('input[name=classFile]').parentsUntil('.form').before($('<p/>').text("사진을 최소 4장이상 등록해주세요").css(
						"text-align", "center").css("color", "#f20000"));
				}
				return check;
			}


			// 파일들 원하는 input에 담기
			function inputFile() {
				const dataTransfer = new DataTransfer();
				applyFileList.forEach(file => {
					dataTransfer.items.add(file);
				});
				$('input[name=classFile]')[0].files = dataTransfer.files; //제거 처리된 FileList를 돌려줌
			}

			$('.insertClassInfo').on('click', function () {
				oEditors.getById["ir1"].exec("UPDATE_CONTENTS_FIELD", []);
				insertClassInfo();
			})

			// 강의등록
			function insertClassInfo() {
				inputFile();
				let memberId = "[[${#authentication.principal.memberId}]]";
				let data = new FormData($('.form')[0]);
				data.append('memberId', memberId);
				$.ajax({
					url: '/class/classInfoInsert',
					enctype: 'multipart/form-data',
					method: 'POST',
					processData: false,
					contentType: false,
					data: data,
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
					success: function (result) {
						$('#addClassInfo').modal("hide");
						$(document).find('.products-row').remove();
						$(result).each(function (index, item) {
							let classdate = new Date(item.classDate);
							let year = classdate.getFullYear();
							let month = classdate.getMonth() + 1;
							let date = classdate.getDate();
							let newClass = $(`<div class="products-row" th:id="${item.classId}">
				<div class="product-cell image">
					<img src="/fileView/${item.media.fileRoute}" alt="product"> <span
						>${item.className}</span>
				</div>
				<div class="product-cell category">
					<span class="cell-label">클래스ID:</span>${item.classId}
				</div>
				<div class="product-cell sales">
					<span class="cell-label">등록일자:</span>${year}년 ${month}월 ${date}일
				</div>
				<div class="product-cell status-cell">
					<span class="cell-label">클래스상태:</span><span class="status active">${item.status}</span>
				</div>
			</div>`);
							$('.tableView').append(newClass);
						})
					},
					error: function (error) {
						console.log(error);
						alert('실패');
					}
				})
			}

			// 강의 날짜 가져오기
			function getDateList() {
				$.ajax({
					url: '/class/getDateList',
					method: 'GET',
					contentType: 'application/x-www-form-urlencoded',
					data: { 'classId': groupId },
					async: false,
					success: function (result) {
						DateList = result;
					},
					error: function (error) {
						alert('실패');
					}
				})
			}
			// 강의 있는 날짜 css 변경
			function changeDate(date) {
				let checked = 0;
				$(DateList).each(function (index, item) {
					if (date == item.classDate) {
						checked = 1;
						return;
					}
				})
				$(selectList).each(function (index, item) {
					if (date == item) {
						checked = 2;
						return;
					}
				})
				return checked;
			}

			function getclassList(date) {
				console.log(date);
				$.ajax({
					url: '/class/getclassList',
					method: 'GET',
					contentType: 'application/x-www-form-urlencoded',
					data: {
						'classId': groupId,
						'classDate': date
					},
					async: false,
					success: function (result) {
						$('.classTable').find('tbody').children().remove();
						$(result).each(function (index, item) {
							let trDate = $(`<tr class="dayClass" id="${item.cno}">
								<td>${item.startTime}</td>
								<td><span>${item.bookingPeople}</span>/<span>${item.totalPeople}</span></td>
								</tr>`);
							$(trDate).on('click', function () {
								$('.classTable').find('tbody').children().removeClass('selectedClass');
								$(this).addClass('selectedClass');
								$('input[name=people]').attr('max', item.totalPeople - item.bookingPeople);
							})
							$('.classTable').find('tbody').append(trDate);
						})
					},
					error: function (error) {
						console.log(error);
						alert('실패');
					}
				})
			}

			// 날짜 선택
			function selectDay(date) {
				let result = true;
				let check = true;
				const date1 = new Date();
				const date2 = new Date(date);
				if (date1.getTime() >= date2.getTime()) {
					result = false;
					return result;
				}
				$(selectList).each(function (index, item) {
					if (date == item) {
						selectList.splice(index, 1);
						check = false;
						result = false;
						return;
					}
				})
				if (check) {
					selectList.push(date);
				}
				return result;
			}

			$('.addTime').on('click', function () {
				let trDate = $(`<tr class="dayClass">
								<td><input type="number" value="00" min="1" max="24" name="classTime"
										class="input"> : <input type="number" value="00" min="1" max="59" name="classTime"
										class="input"></td>
								</tr>`);
				$(trDate).find('input').each(function () {
					$(this).on('change', function () {
						if (!!Number($(this).val())) {

						} else {
							$(this).val(1);
						}
					})
				})
				$('.classTable').find('tbody').append(trDate);
			})

			function sDateFormat(date) {
				let dateList = date.split('/');
				let selectDate = '';
				dateList.forEach((t, index) => {
					if (index == 0) {
						selectDate += t;
					} else if (t.length == 1) {
						selectDate += `0${t}`;
					} else {
						selectDate += t;
					}
				});
				return selectDate;
			}

			$('.insertClass').on('click', function () {
				$(selectList).each(function () {
					let selectDate = sDateFormat(this);
					$('.classTable').find('.dayClass').each(function () {
						let classDate = selectDate;
						if ($(this).find('input').eq(0).val().length == 1) {
							classDate += '0' + $(this).find('input').eq(0).val();
						} else {
							classDate += $(this).find('input').eq(0).val();
						}
						if ($(this).find('input').eq(1).val().length == 1) {
							classDate += '0' + $(this).find('input').eq(1).val();
						} else {
							classDate += $(this).find('input').eq(1).val();
						}
						insertClass(classDate);
					})
				})
				$('#addClass').modal("hide");
				selectList = [];
			})

			function insertClass(classDate) {
				$.ajax({
					url: '/class/classInsert',
					method: 'POST',
					contentType: 'application/x-www-form-urlencoded',
					data: {
						'classId': groupId,
						'startTime': classDate
					},
					beforeSend: function (xhr) {
						xhr.setRequestHeader(header, token);
					},
					success: function (result) {
					},
					error: function (error) {
						console.log(error);
						alert('실패');
					}
				})
			}

		</script>
		<script th:src="@{/js/calendar2.js}"></script>
		<script>
			$(document).find('.addClass').each(function () {
				$(this).on('click', function () {
					groupId = $(this).parentsUntil('.tableView').eq(1).attr('id');
					getDateList();
					$('#addClass').modal("show");
					$('#calendar').removeClass();
					$('#calendar').children().remove();
					makeCalendar(true);
				})
			})
		</script>
		<script type="text/javascript">
			document.querySelector(".jsFilter").addEventListener(
				"click",
				function () {
					document.querySelector(".filter-menu").classList
						.toggle("active");
				});

			document
				.querySelector(".grid")
				.addEventListener(
					"click",
					function () {
						document.querySelector(".list").classList
							.remove("active");
						document.querySelector(".grid").classList
							.add("active");
						document
							.querySelector(".products-area-wrapper").classList
							.add("gridView");
						document
							.querySelector(".products-area-wrapper").classList
							.remove("tableView");
					});

			document
				.querySelector(".list")
				.addEventListener(
					"click",
					function () {
						document.querySelector(".list").classList
							.add("active");
						document.querySelector(".grid").classList
							.remove("active");
						document
							.querySelector(".products-area-wrapper").classList
							.remove("gridView");
						document
							.querySelector(".products-area-wrapper").classList
							.add("tableView");
					});

			var modeSwitch = document.querySelector('.mode-switch');
			modeSwitch.addEventListener('click', function () {
				document.documentElement.classList.toggle('light');
				modeSwitch.classList.toggle('active');
			});
		</script>
		<!-- JS -->
		<th:block layout:fragment="script">
			<script th:src="@{/js/bootstrap.min.js}"></script>
			<script th:src="@{/shoptemplate/js/jquery-3.3.1.min.js}"></script>
			<script th:src="@{/shoptemplate/js/jquery.nice-select.min.js}"></script>
			<script th:src="@{/shoptemplate/js/jquery-ui.min.js}"></script>
			<script th:src="@{/shoptemplate/js/jquery.slicknav.js}"></script>
			<script th:src="@{/shoptemplate/js/mixitup.min.js}"></script>
			<script th:src="@{/shoptemplate/js/owl.carousel.min.js}"></script>
			<script th:src="@{/shoptemplate/js/main.js}"></script>
		</th:block>
	</div>

</body>

</html>