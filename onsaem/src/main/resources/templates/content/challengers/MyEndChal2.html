<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
   xmlns:th="http://www.thymeleaf.org"
   xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
   layout:decorate="~{layout/layout}">
<!-- sss -->
<!-- index.html 고유 CSS 추가 -->
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style type="text/css">
		button {
		   cursor: pointer;
		}
		
		.btn {
		   margin-top: 60px;
		}
		
		.modal {
		   display: flex;
		   justify-content: center;
		   align-items: center;
		   position: fixed;
		   top: 0;
		   left: 0;
		   width: 100%;
		   height: 100%;
		}
		
		.modal__background {
		   background-color: rgba(0, 0, 0, 0.6);
		   width: 100%;
		   height: 100%;
		   position: absolute;
		}
		
		.modal__content {
		   text-align: center;
		   position: relative;
		   background-color: white;
		   border-radius: 10px;
		   top: 0;
		   padding: 10px 25px;
		   width: 20%;
		}
		
		h1 {
		   margin: 0;
		   margin-bottom: 13px;
		}
		
		.hidden {
		   display: none;
		}
		.modal-custom-button{
			background-color : #FADBDF;
			border : none;
			margin : 5px;
			width : 120px;
			height : 40px;
			border-radius : 10px
		}
		
		/* 프로그레스바 */
		 #progress {
		 	appearance: none;
		}
		#progress::-webkit-progress-bar {
		    background:#f0f0f0;
		    height : 20px;
		    border-radius:10px;
		    box-shadow: inset 3px 3px 10px #ccc;
		}
		#progress::-webkit-progress-value {
		    border-radius:10px;
		    background: #1D976C;
		    background: -webkit-linear-gradient(to right, #93F9B9, #1D976C);
		    background: linear-gradient(to right, #93F9B9, #1D976C);
		
		}

</style>
</head>

<th:block layout:fragment="css">
   <!--    <link rel="stylesheet" th:href="@{/css/page/home.css}" >-->
   <link rel="stylesheet" th:href="@{/challengers/css/mycss.css}">
   <link rel="stylesheet" th:href="@{/shoptemplate/css/style.css}"
      type="text/css">
   	<link rel="stylesheet"
		th:href="@{/shoptemplate/css/font-awesome.min.css}" type="text/css">
	<link rel="stylesheet" th:href="@{/shoptemplate/css/elegant-icons.css}"
		type="text/css">
	<link rel="stylesheet" th:href="@{/shoptemplate/css/nice-select.css}"
		type="text/css">
	<link rel="stylesheet"
		th:href="@{/shoptemplate/css/shop/css/jquery-ui.min.css}"
		type="text/css">
	<link rel="stylesheet"
		th:href="@{/shoptemplate/css/owl.carousel.min.css}" type="text/css">
	<link rel="stylesheet" th:href="@{/shoptemplate/css/slicknav.min.css}"
		type="text/css">
	<link rel="stylesheet" th:href="@{/shoptemplate/css/style.css}"
		type="text/css">

</th:block>
<script src="/resources/vendor/bootstrap/js/bootstrap.min.js"></script>





<!-- Content -->
<div layout:fragment="content">

   <section class="breadcrumb-section set-bg"
      th:data-setbg="@{/shoptemplate/img/breadcrumb.jpg}">
      <div class="container">
         <div class="row">
            <div class="col-lg-12 text-center">
               <div class="breadcrumb__text">
                  <h2>Challengers</h2>
                  <div class="breadcrumb__option">
                     <a href="./index.html">Home</a> <a href="./index.html">Vegetables</a>
                     <span>Vegetable’s Package</span>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </section>

   <div class="app-container">


      <div class="app-content">

                  <div class="app-sidebar">
            <a href="/mypage/myCurrentChal" class="app-sidebar-link active">
            	 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="feather feather-home">
			          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
			          <polyline points="9 22 9 12 15 12 15 22" />
			     </svg>
            </a>
            <a href="/mypage/myBeforeChal" class="app-sidebar-link"> 
            	<svg
                  class="link-icon feather feather-pie-chart"
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  fill="none" stroke="currentColor" stroke-linecap="round"
                  stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          			<defs />
          			<path d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2v10z" />
        		</svg>
            </a> 
            <a href="/mypage/myEndChal" class="app-sidebar-link">
            	 <svg
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                  class="feather feather-calendar">
		          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
		          <line x1="16" y1="2" x2="16" y2="6" />
		          <line x1="8" y1="2" x2="8" y2="6" />
		          <line x1="3" y1="10" x2="21" y2="10" /></svg>
            </a> 
            <a href="/mypage/myApplyNgo" class="app-sidebar-link">
            	 <svg
                  class="link-icon feather feather-pie-chart"
                  xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                  fill="none" stroke="currentColor" stroke-linecap="round"
                  stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          		<defs />
          		<circle cx="12" cy="12" r="3" />
         		 <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
        		</svg>
            </a>
         </div>
         
         <div class="projects-section">
            <div class="projects-section-header">
               <p>완료 챌린저스</p>
               <p class="time">December, 12</p>
            </div>
            <div class="projects-section-line">
               <div class="projects-status">
                  <div class="item-status">
                     <span class="status-number">45</span> <span class="status-type">In
                        Progress</span>
                  </div>
                  <div class="item-status">
                     <span class="status-number">24</span> <span class="status-type">Upcoming</span>
                  </div>
                  <div class="item-status">
                     <span class="status-number">62</span> <span class="status-type">Total
                        Projects</span>
                  </div>
               </div>
               <div class="view-actions">
                  <button class="view-btn list-view" title="List View">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-list">
                                <line x1="8" y1="6" x2="21" y2="6" />
                                <line x1="8" y1="12" x2="21" y2="12" />
                                <line x1="8" y1="18" x2="21" y2="18" />
                                <line x1="3" y1="6" x2="3.01" y2="6" />
                                <line x1="3" y1="12" x2="3.01" y2="12" />
                                <line x1="3" y1="18" x2="3.01" y2="18" /></svg>
                  </button>
                  <button class="view-btn grid-view active" title="Grid View">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="feather feather-grid">
				              <rect x="3" y="3" width="7" height="7" />
				              <rect x="14" y="3" width="7" height="7" />
				              <rect x="14" y="14" width="7" height="7" />
				              <rect x="3" y="14" width="7" height="7" /></svg>
                  </button>
               </div>
            </div>
            <div class="project-boxes jsGridView">
               <!-- 한개 -->
               <div class="project-box-wrapper" th:each="chal:${chals}">
                  <div class="project-box" style="background-color: #fee4cb;">
                     <div class="project-box-header"></div>
                     <div class="project-box-content-header">
                        <p class="box-content-header" th:text="${chal.chalName}">Web
                           Designing</p>
                        <p class="box-content-subheader" th:text="${chal.subClass}+'전'">Prototyping</p>
                     </div>
                     <p
                        th:text="${#dates.format(chal.startDate, 'MM월 dd일')} + ' ~ ' + ${#dates.format(chal.endDate, 'MM월 dd일')}"></p>
                     <div class="project-box-footer">
                        <div class="participants">
                        	<input type="hidden" th:name="chalId" th:value="${chal.chalId}">
                       		<input type="hidden" th:name="subClass" th:value="${chal.subClass}" id="subClass">
							<button th:if="${chal.receipt} !=null" class="modal-custom-button" th:value="${chal.chalId}" name="영수증" th:onclick="displayModal(this)">기부영수증 ⭕</button>
							<button th:if="${chal.receipt} == null" class="modal-custom-button" th:value="${chal.chalId}" name="영수증">기부영수증 ❌</button>
							<button th:if="${chal.resultPoint} !=null" class="modal-custom-button" name="포인트" th:onclick="displayModal(this)" th:value="${chal.chalId}">포인트 확인</button>
							<button th:if="${chal.resultPoint} ==null" class="modal-custom-button" name="포인트" th:onclick="displayModal(this)" th:value="${chal.chalId}">포인트 미정산</button>
                        </div>
                     </div>

                  </div>

                  <!-- 모달창 -->

						<!--모달창  --> 
						<div class="modal hidden">
							<div class="modal__background"></div>
							
								<div id="receiptFrm" class="modal__content">
										<h5>기부 영수증</h5>
										<img id="receipt">
										<button type="button" class="closeBtn" id="closeModals">닫기</button>
								</div>
								<div id ="point" class="modal__content">
									<h4>포인트정산</h4>
									<input type="hidden" id="groupId" name="groupId">
					
									<!-- 본인 기부금 띄우기  -->
									<b>나의 기부금</b><p id="privateDonate"></p>									
									<!-- 프로그레스바 -->
									<b>나의 달성률</b><p id="successPC"></p>
									<progress id="progress" min="0" max="100" style=width:100%></progress>
									
									<!-- 정산 포인트 띄우기 --> 
									<b>나의 결과 포인트 </b><p id="resultPoint"></p>	
									
									<button type="button" class="closeBtn" id="closeModals">닫기</button>
								</div>
								
								<div id ="teamPoint" class="modal__content">
									<h5>포인트정산</h5>
									<input type="hidden" id="groupId" name="groupId">
									<input type="hidden" id="pp">
									<b>챌린지 결과 </b><p id="teamResult"></p>
									<b>전체 모금 금액</b><p id="donationFee"></p>
									<b>포인트 결과</b><p id="teamPoint"></p>

									<!-- 차트 -->
									<b>우리팀 평균 달성률</b><p id="successPC"></p>
									<progress id="MyTeamBar" min="0" max="100" style=width:100%></progress>
									<b>상대팀 평균 달성률</b><p id="successPC"></p>
									<progress id="EnemyBar" min="0" max="100" style=width:100%></progress>
									
									<button type="button" class="closeBtn" id="closeModals">닫기</button>
								</div>
							
						</div>
						<!--모달창 끝  -->
						
				   <!-- 끝 -->
               </div>
            </div>
         </div>
      </div>
   </div>
	
   <!-- index.html 고유 스크립트 추가 -->
   <th:block layout:fragment="script">
      <script th:src="@{/shoptemplate/js/main.js}"></script>
   </th:block>
   <script type="text/javascript">
	//csrf설정
	 var token = $("meta[name='_csrf']").attr("content");
	 var header = $("meta[name='_csrf_header']").attr("content");
	 
      document.addEventListener('DOMContentLoaded', function() {
         var modeSwitch = document.querySelector('.mode-switch');

         modeSwitch.addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            modeSwitch.classList.toggle('active');
         });

         var listView = document.querySelector('.list-view');
         var gridView = document.querySelector('.grid-view');
         var projectsList = document.querySelector('.project-boxes');

         listView.addEventListener('click', function() {
            gridView.classList.remove('active');
            listView.classList.add('active');
            projectsList.classList.remove('jsGridView');
            projectsList.classList.add('jsListView');
         });

         gridView.addEventListener('click', function() {
            gridView.classList.add('active');
            listView.classList.remove('active');
            projectsList.classList.remove('jsListView');
            projectsList.classList.add('jsGridView');
         });

         document.querySelector('.messages-btn').addEventListener(
               'click',
               function() {
                  document.querySelector('.messages-section').classList
                        .add('show');
               });

         document.querySelector('.messages-close').addEventListener(
               'click',
               function() {
                  document.querySelector('.messages-section').classList
                        .remove('show');
               });
      });
      

      //모달창 생성
		//모달창 생성
		document.querySelectorAll(".openBtn").forEach((openBtn) => {
			console.log(openBtn);
			openBtn.addEventListener("click", displayModal);
			
		})
		const modal = document.querySelector(".modal");
		const closeButton = modal.querySelector(".closeBtn");
		const modalBackground = modal.querySelector(".modal__background");

		function displayModal(data) {
			
			console.log(data);
			let name = data.name;
			let groupId = data.value;
			 //let subClassVal = $(data).closest("tr").find('#teamChalId').text();
			 let subClassVal = $(data).closest("div.participants").find("input[name='subClass']").val()
			 
			if(name == '영수증'){
				//영수증 불러오기 이미지파일,,
	        	$.ajax({
	        		url:'/mypage/seeRecepit',
	        		method : 'POST',
	        		  beforeSend : function(xhr)
	                  {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	                  xhr.setRequestHeader(header, token);
	                  },
	        		data : {groupId, groupId},
	        		success : function(result){
	        			//console.log(result);
	        			let imgsrc = result.fileRoute;
	        			$('#receipt').attr("src", '/fileView/'+imgsrc);
	        			
	        		},
	        		error : function(error){
	        			console.log(error);
	        		}
	        	})
	        	$('#receiptFrm').show();
    			$("#point").hide();
				$("#teamPoint").hide();
				modal.classList.toggle("hidden");
			}else if(name =='포인트' && subClassVal=='개인'){
				console.log(subClassVal);
				console.log(groupId);
				//개인전  포인트 가져오기
				$.ajax({
					url : '/mypage/checkPoint',
	  				method :'POST',
	  				data : {chalId : groupId},
	  				beforeSend : function(xhr)
		                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
		                xhr.setRequestHeader(header, token);
		                },
	  				success:function(result){
	  					console.log(result);
	  					//받아온 데이터를 필요한 곳에 넣기
	  					let percent = result.user.result;
	  					let resultPoint = result.user.resultPoint;
	  					let money = result.user.privateDonate;
	  					let length = percent.length-1
	  					let pp = Number(percent.substr(0,length));
	  					$('#privateDonate').text(money);
	  					$('#resultPoint').text(resultPoint);
	  					$('#successPC').text(percent);
	  					$('#progress').val(pp);
	  					
	  				},
	  				error : function(error){
	  					console.log(error);
	  				}
				})
				$('#receiptFrm').hide();
    			$("#point").show();
				$("#teamPoint").hide();
				modal.classList.toggle("hidden");
			}else if(name =='포인트' && subClassVal=='팀'){
				//팀꺼 가져오기
				$.ajax({
					url : '/mypage/checkPoint',
	  				method :'POST',
	  				data : {chalId : groupId},
	  				beforeSend : function(xhr)
		                {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
		                xhr.setRequestHeader(header, token);
		                },
	  				success:function(result){
	  					console.log(result);
	  					//받아온 데이터를 필요한 곳에 넣기
	  					//총 기부금
	  					let donationFee = result.totalInfo.donationFee;
	  					$('#donationFee').text(donationFee);
	  					//나의 팀 결과
	  					let teamResult = result.user.result;
	  					$('#teamResult').text(teamResult);
	  					//나의 팀
	  					let myTeam = result.user.team;
	  					//나의 resultPoint
	  					resultPoint = result.user.resultPoint;
	  					console.log(resultPoint);
	  					//$('#teamPoint').text(resultPoint);
	  					if(myTeam=='A'){
	  						//평균 달성률
	  						let Amom = Math.abs(Number(result.totalInfo.total))*result.Asize;
	  						let Ason = result.cntA;
	  						let Apct = (Ason/Amom)*100;
	  						//고쳐야함 임의로 띄운것 - Apct로
	  						$('#MyTeamBar').val(70);
	  						
	  						let Bmom = Math.abs(Number(result.totalInfo.total))*result.Bsize; 
	  						let Bson = result.cntB;
	  						let Bpct = (Bson/Bmom)*100;
	  						//임의로 띄운거 Bpct로 고쳐야함 
	  						$('#EnemyBar').val(30);
	  					}else {
	  						//내 팀이 B팀일때
		  					//평균 달성률
		  						let Amom = Math.abs(Number(result.totalInfo.total))*result.Asize;
		  						let Ason = result.cntA;
		  						let Apct = (Ason/Amom)*100;
		  						
		  						$('#EnemyBar').val(Apct);
		  						
		  						let Bmom = Math.abs(Number(result.totalInfo.total))*result.Bsize; 
		  						let Bson = result.cntB;
		  						let Bpct = (Bson/Bmom)*100;
		  						$('#MyTeamBar').val(Bpct);  						
	  					}

	  				},
	  				error : function(error){
	  					console.log(error);
	  				}
				})
				
				$('#receiptFrm').hide();
    			$("#point").hide();
				$("#teamPoint").show();
				modal.classList.toggle("hidden");
			}
			
		}

		
		closeButton.addEventListener("click", displayModal)
		modalBackground.addEventListener("click", displayModal);
		//=----모달창관련 스크립트 끝
      
		
   </script>
</div>
</html>