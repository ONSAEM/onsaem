<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<!-- index.html 고유 CSS 추가 -->
<th:block layout:fragment="css">
	<!--    <link rel="stylesheet" th:href="@{/css/page/home.css}" >-->
	<link rel="stylesheet" th:href="@{/challengers/css/mycss.css}">
	<link rel="stylesheet" th:href="@{/challengers/css/nomargin.css}" type="text/css">
	<link rel="stylesheet" th:href="@{/challengers/css/mypage.css}" >

</th:block>
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
	.app-content{
	width: 70%;
    margin: auto;
	}
	button {
   all: unset;
   background-color: mediumslateblue;
   color: white;
   padding: 5px 25px;
   border-radius: 10px;
   cursor: pointer;
	}
	
	.btn {
	   margin-top: 60px;
	}
	
	.modal {
	   display: flex;
	   justify-content: center;
	   align-items: center;
	   position: fixed;
	   top: 0;
	   left: 0;
	   width: 100%;
	   height: 100%;
	}
	
	.modal__background {
	   background-color: rgba(0, 0, 0, 0.6);
	   width: 100%;
	   height: 100%;
	   position: absolute;
	}
	
	.modal__content {
	   text-align: center;
	   position: relative;
	   background-color: white;
	   border-radius: 10px;
	   top: 0;
	   padding: 10px 25px;
	   width: 20%;
	}
	
	h1 {
	   margin: 0;
	   margin-bottom: 13px;
	}
	
	.hidden {
	   display: none;
	}
	#content{
		width : 100%;
	}
</style>
</head>

<!-- Content -->
<div layout:fragment="content">

	<section class="breadcrumb-section set-bg" th:data-setbg="@{/shoptemplate/img/breadcrumb.jpg}">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb__text">
                        <h2>Challengers</h2>
                        <div class="breadcrumb__option">
                            <a href="./index.html">Home</a>
                            <a href="./index.html">Vegetables</a>
                            <span>Vegetable’s Package</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

	<div class="app-container">


		<div class="app-content">

			<div class="app-sidebar">
				<a href="" class="app-sidebar-link active"> 
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
          <polyline points="9 22 9 12 15 12 15 22" /></svg>
				</a> <a href="" class="app-sidebar-link"> <svg
						class="link-icon feather feather-pie-chart"
						xmlns="http://www.w3.org/2000/svg" width="24" height="24"
						fill="none" stroke="currentColor" stroke-linecap="round"
						stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          <defs />
          <path
							d="M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2v10z" />
        </svg>
				</a> <a href="" class="app-sidebar-link"> <svg
						xmlns="http://www.w3.org/2000/svg" width="24" height="24"
						viewBox="0 0 24 24" fill="none" stroke="currentColor"
						stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
						class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" /></svg>
				</a> <a href="" class="app-sidebar-link"> <svg
						class="link-icon feather feather-pie-chart"
						xmlns="http://www.w3.org/2000/svg" width="24" height="24"
						fill="none" stroke="currentColor" stroke-linecap="round"
						stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24">
          <defs />
          <circle cx="12" cy="12" r="3" />
          <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" />
        </svg>
				</a>
			</div>
			<div class="projects-section">
				<div class="projects-section-header">
					<p>Projects</p>
					<p class="time">December, 12</p>
				</div>
				<div class="projects-section-line">
					<div class="projects-status">
						<div class="item-status">
							<span class="status-number">45</span> <span class="status-type">In
								Progress</span>
						</div>
						<div class="item-status">
							<span class="status-number">24</span> <span class="status-type">Upcoming</span>
						</div>
						<div class="item-status">
							<span class="status-number">62</span> <span class="status-type">Total
								Projects</span>
						</div>
					</div>
					<div class="view-actions">
						<button class="view-btn list-view" title="List View">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
								viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
								class="feather feather-list">
						              <line x1="8" y1="6" x2="21" y2="6" />
						              <line x1="8" y1="12" x2="21" y2="12" />
						              <line x1="8" y1="18" x2="21" y2="18" />
						              <line x1="3" y1="6" x2="3.01" y2="6" />
						              <line x1="3" y1="12" x2="3.01" y2="12" />
						              <line x1="3" y1="18" x2="3.01" y2="18" /></svg>
						</button>
						<button class="view-btn grid-view active" title="Grid View">
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
								viewBox="0 0 24 24" fill="none" stroke="currentColor"
								stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
								class="feather feather-grid">
						              <rect x="3" y="3" width="7" height="7" />
						              <rect x="14" y="3" width="7" height="7" />
						              <rect x="14" y="14" width="7" height="7" />
						              <rect x="3" y="14" width="7" height="7" /></svg>
						</button>
					</div>
				</div>
<div class="project-boxes jsGridView">
	<div class="container">

		<div class="profile">

			<div class="profile-image">

				<img src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="">

			</div>

			<div class="profile-user-settings">

				<h1 class="profile-user-name" th:text="${chal.chalName}">janedoe_</h1>

				<button class="btn profile-edit-btn">Edit Profile</button>

				<button class="btn profile-settings-btn" aria-label="profile settings"><i class="fas fa-cog" aria-hidden="true"></i></button>

			</div>

			<div class="profile-stats">
				<ul>
					<li>시작일 <span class="profile-stat-count" th:text="${#dates.format(chal.startDate, 'MM월 dd일')}" id="startDate" >164</span></li>
					<li>종료일 <span class="profile-stat-count" th:text="${#dates.format(chal.endDate, 'MM월 dd일')}" id="endDate" th:value="${chal.endDate}">188</span> followers</li>
					<li><span class="profile-stat-count">206</span> following</li>
				</ul>

			</div>

			<div class="profile-bio">

				<p>챌린지 <span class="profile-real-name" th:text="${chal.chalName}">Jane Doe</span>가 종료일까지 <span class="profile-real-name" th:text="${dday}">Jane Doe</span>일 남았어요. 남은 날들도 화이팅!</p>

			</div>

		</div>
		<!-- End of profile section -->

	</div>
	<!-- End of container -->

		<!-- 도넛차트 -->
		<div id="chart" th:if="${chal.subClass} =='팀'" style=" text-align : center; width:500px; margin-left:300px;">
			<h3>우리 [[${myTeam}]]의 달성률</h3>	
			<canvas id="chDonut1" ></canvas>
		</div>
		<div id="chart" th:if="${chal.subClass} =='개인'" style=" text-align : center; width:500px; margin-left:300px;">
			<h3>[[${chal.chalName}]] 참가자 달성률</h3>	
			<canvas id="chDonut2" ></canvas>
		</div>	



	<div class="container">

		<div class="gallery">

			<div class="gallery-item openDetail" tabindex="0" th:each="proof:${proofs}" th:onclick="displayModal([[${proof}]])">

				<img src="'/fileView/'+${proof.fileRoute}" class="gallery-image">
					<input type="hidden" id="chalId" th:value="${proof.chalId}">
				<div class="gallery-item-info">

					<ul>
						<li class="gallery-item-likes"><span class="visually-hidden">작성일:</span><i class="fas fa-heart" aria-hidden="true" th:text="${#dates.format(proof.writeDate, 'yyyy-MM-dd')}"></i></li>
						<!-- <li class="gallery-item-comments"><span class="visually-hidden">Comments:</span><i class="fas fa-comment" aria-hidden="true"></i> 2</li> -->
					</ul>

				</div>

			</div>

			
		</div>
		<!-- End of gallery -->

		<div class="loader"></div>

	</div>	    

				</div>
			</div>

		</div>

		 <!-- 모달창 -->
                  <div class="modal hidden">
                     <div class="modal__background"></div>
                     <div class="modal__content" id="insta">
                    
                        	<span><p id="writer"></p></span>
                        	<button id="on" onclick="openFrm()" style="display: on;">신고</button>	
                        	<input type="hidden" id="theId">
                           <img style="width: 500px;" id="image">
		                   <p id="contents"></p>      
                           <table>
                           <thead><tr>
                           			<th>댓쓴이</th>
                           			<td>댓글내용</td>
                           		</tr></thead>
                           		<tbody class="replies">
                           		</tbody>
                           </table>
                            <span><img src="/challengers/redheart.png" id="redHeart"  th:onclick="delLike()" type="button" style="width:5%">
                				<img src="/challengers/heart.png" th:onclick="addLike()" type="button" style="width:5%" id="whiteHeart" >좋아요 <p id="cnt"></p></span>
                           <input type="text" id="content" name="content">
                           <button type="button" th:onclick="inputReply()">댓글쓰기</button>
                           <button type="button" class="closeBtn">닫기</button>
                        
                     </div>
                     <div id="reportFrm" style="display : none;" class="modal__content">
                     <!-- 신고폼 -->
                        <form >
                        	<input type="hidden" id="theId">
                           	<select id="reason">
                           		<option value="">==신고 사유 고르기==</option>
                           		<option value="악성댓글">악성댓글</option>
                           		<option value="주제와관련없는인증">주제와 관련 없는 인증</option>
                           	</select>
                           	<label>신고대상</label><input type="text" id="toId" placeholder="신고대상의 아이디">
                           	<textarea id="detailReason" placeholder="상세 사유를 작성해주세요"></textarea>
                           <button type="button" th:onclick="inputReport()">신고</button>
                           <button type="button" class="closeBtn" onclick="offFrm()">닫기</button>
                          </form>
                     </div>
                  </div>
                  <!-- 모달창 끛-->
                  
             
		
		<script type="text/javascript">
		//csrf설정
		 var token = $("meta[name='_csrf']").attr("content");
		 var header = $("meta[name='_csrf_header']").attr("content");
		 
		/* document.addEventListener('DOMContentLoaded', function () {
	 		 var modeSwitch = document.querySelector('.mode-switch');

	  		modeSwitch.addEventListener('click', function () {
	  			document.documentElement.classList.toggle('dark');
	   		 	modeSwitch.classList.toggle('active');
			  });
			  
			  var listView = document.querySelector('.list-view');
			  var gridView = document.querySelector('.grid-view');
			  var projectsList = document.querySelector('.project-boxes');
			  
			  listView.addEventListener('click', function () {
			    gridView.classList.remove('active');
			    listView.classList.add('active');
			    projectsList.classList.remove('jsGridView');
			    projectsList.classList.add('jsListView');
			  });
			  
			  gridView.addEventListener('click', function () {
			    gridView.classList.add('active');
			    listView.classList.remove('active');
			    projectsList.classList.remove('jsListView');
			    projectsList.classList.add('jsGridView');
			  });
			  
			  document.querySelector('.messages-btn').addEventListener('click', function () {
			    document.querySelector('.messages-section').classList.add('show');
			  });
			  
			  document.querySelector('.messages-close').addEventListener('click', function() {
			    document.querySelector('.messages-section').classList.remove('show');
			  });
			}); */
			
		//차트관련
		 let subClass = "[[${chal.subClass}]]";
		if(subClass == '팀'){
			 let myteamcnt = Number("[[${MyTeamCnt}]]");
			 let myteamsize = Number("[[${MyTeamSize}]]");
			 let total = Number("[[${chal.total}]]")*myteamsize;
			 let pteam = (myteamcnt/total).toFixed(1)*100;
			 var colors = ['#b4a7d6','#eae5e1','#333333','#c3e6cb','#dc3545','#6c757d'];
			var donutOptions = {
				  cutoutPercentage: 85, 
				  legend: {position:'bottom', padding:5, labels: {pointStyle:'circle', usePointStyle:true}}
				};
		
			var data = new Array();
			data.push(pteam);
			data.push(100-pteam);
				// donut 1
				var chDonutData1 = {
				    labels: ['평균달성률'],
				    datasets: [
				      {
				        backgroundColor: colors.slice(0,2),
				        borderWidth: 0,
				        data: data
				      }
				    ]
				};
				
				var chDonut1 = document.getElementById("chDonut1");
				if (chDonut1) {
				  new Chart(chDonut1, {
				      type: 'doughnut',
				      data: chDonutData1,
				      options: donutOptions
				  });
				} 
				
		}else{
			 let chalSize = Number("[[${ChalSize}]]");
			 let chalCnt = Number("[[${ChalCnt}]]");
			 let total = Number("[[${chal.total}]]")*chalSize;
			 let pt = (chalCnt/total).toFixed(1)*100;
			 var colors = ['#b4a7d6','#eae5e1','#333333','#c3e6cb','#dc3545','#6c757d'];
				var donutOptions = {
					  cutoutPercentage: 85, 
					  legend: {position:'bottom', padding:5, labels: {pointStyle:'circle', usePointStyle:true}}
					};
			
				var data = new Array();
				data.push(pt);
				data.push(100-pt);
					// donut 1
					var chDonutData2 = {
					    labels: ['평균달성률'],
					    datasets: [
					      {
					        backgroundColor: colors.slice(0,2),
					        borderWidth: 0,
					        data: data
					      }
					    ]
					};
					
					var chDonut2 = document.getElementById("chDonut2");
					if (chDonut2) {
					  new Chart(chDonut2, {
					      type: 'doughnut',
					      data: chDonutData2,
					      options: donutOptions
					  });
					} 
			 
		}
			
		//모달창 생성
	    
	      const modal = document.querySelector(".modal");
	      const closeButton = modal.querySelector(".closeBtn");
	      const modalBackground = modal.querySelector(".modal__background");

	      function displayModal(data) {
	    	  let proofId = data.proofId;
	    	  $('#theId').val(data.proofId);
	    	 
	    	  $(".replies").val();
		       //ajax 호출 
		       		$.ajax({
		      			url: '/mypage/proofDetail',
					      method: 'POST',
					      beforeSend : function(xhr)
			               {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
			               xhr.setRequestHeader(header, token);
			               },
					      //contentType: 'application/plain',
					      data: {proofId : proofId},
					      success: function (result) {
					    	  $('#image').attr("src", '/fileView/'+result.brd.fileRoute);
					    	  
					    	$('.replies').html("");
					    	  let list = result.repllies;
					    	  let brd = result.brd;
					    	  var str = '<TR>';
					    	  let tbl =  $.each(list , function(i){
					    		  str += '<TD>' + list[i].writerId + '</TD><TD>' + list[i].content+'</TD><TD>'+list[i].replyDate+ '</TD>';
					                  str += '</TR>';
					             });
					    	  $(".replies").append(str);

					    	 $("#cnt").text(result.likeCnt);
					    	 //인증글 내용 넣기
					    	  document.querySelector("#contents").innerText=result.brd.content;
					    	 //글쓴이 넣기
					    	  document.querySelector("#writer").innerText=result.brd.proofWriter;
					    	 //좋아요 여부 확인
					    	 let check = result.checkLike;
					    	 if(check == 0){
					    		 $("#whiteHeart").show();
					    		 $("#redHeart").hide();
					    	 }else{
					    		 $("#redHeart").show();
					    		 $("#whiteHeart").hide();	 
					    	 }
					    	  
					      },
					      error: function (error) {
					         console.log(error);
					      }
		      		})
		      		
	         modal.classList.toggle("hidden");
	       
	      }

	      
	      closeButton.addEventListener("click", displayModal)
	      modalBackground.addEventListener("click", displayModal);
	      //=----모달창관련 스크립트 끝
	      
	      //댓글 달기
	      function inputReply(){
	    	let content = $('#content').val();
	    	let id = document.querySelector('#theId').value;
	    	//아쟉스 아자자
	    	$.ajax({
	    		url : '/mypage/inputReply',
	    		method : 'POST',
	    		  beforeSend : function(xhr)
	               {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	               xhr.setRequestHeader(header, token);
	               },
	    		contentType: 'application/json',
			    data: JSON.stringify({content:content, groupId : id}),
			    success:function(result){
			    	$('.replies').html("");
			    	  let list = result;
			    	  let brd = result.brd;
			    	  var str = '<TR>';
			    	  let tbl =  $.each(list , function(i){
			                  str += '<TD>' + list[i].writerId + '</TD><TD>' + list[i].content+'</TD><TD>'+list[i].replyDate+ '</TD>';
			                  str += '</TR>';
			             });
			    	  $(".replies").append(str);
			    },
			    error : function(error){
			    	console.log(error);
			    }
	    		
	    	})
		      						
	      }
	      
	      //좋아요 하기
	      function addLike(){
	    	  let groupId = document.querySelector('#theId').value;

	    	  $.ajax({
	    		  url : '/mypage/addChalLike',
	    		  method : 'POST',
	    		  beforeSend : function(xhr)
	               {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	               xhr.setRequestHeader(header, token);
	               },
	    		  data : {groupId : groupId},
	    		  success:function(result){
	    			  //좋아요 갯수 변경
	    			  $("#cnt").text(result.likeCnt);
	    			  //하트 변경
	    			  let check = result.checkLike;
				    	 if(check == 0){
				    		 $("#whiteHeart").show();
				    		 $("#redHeart").hide();
				    	 }else{
				    		 $("#redHeart").show();
				    		 $("#whiteHeart").hide();	 
				    	 } 
	    		  },
	    		  error : function(){
	    			  console.log(error);
	    		  }
	    	  })
	      }
	      //좋아요 삭제 ㅎㅎ
	      function delLike(){
	    	  let groupId = document.querySelector('#theId').value;

	    	  $.ajax({
	    		  url : '/mypage/delChalLike',
	    		  method : 'POST',
	    		  beforeSend : function(xhr)
	               {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	               xhr.setRequestHeader(header, token);
	               },
	    		  data : {groupId : groupId},
	    		  success:function(result){
	    			  //좋아요 갯수 변경
	    			  $("#cnt").text(result.likeCnt);
	    			  //하트 변경
	    			  let check = result.checkLike;
				    	 if(check == 0){
				    		 $("#whiteHeart").show();
				    		 $("#redHeart").hide();
				    	 }else{
				    		 $("#redHeart").show();
				    		 $("#whiteHeart").hide();	 
				    	 } 
	    		  },
	    		  error : function(){
	    			  console.log(error);
	    		  }
	    	  })
	    	  
	      }
	      
	      //신고하기 폼 열기
	      function openFrm(){
	    	  $("#insta").hide();
	    	  $("#on").hide();
	    	  $("#reportFrm").show();
	    	  
	      }
	      
	      //신고하기 폼닫기
	      function offFrm(){
	    	  $("#insta").show();
	    	  $("#on").show();
	    	  $("#reportFrm").hide();
	      }
	      
	      //신고하기
	      function inputReport(){
	    	  let toId = $("#toId").val();
	    	  let groupId = document.querySelector('#theId').value;
	    	  let reason = $("#reason").val();
			  let detailReason = $("#detailReason").val();
	    	  
	    	 	$.ajax({
	    		  url : '/mypage/inputReport',
	    		  method : 'POST',
	    		  beforeSend : function(xhr)
	               {   /*데이터를 전송하기 전에 헤더에 csrf값을 설정한다*/
	               xhr.setRequestHeader(header, token);
	               },
	    		  contentType: 'application/json',
				  data: JSON.stringify({reason:reason, toId : toId, detailReason:detailReason}),
				  success:function(result){
					  alert(result.msg);
					  $("#detailReason").val(""); //초기화
					  $("#reason").val(""); //초기화
					  $("#toId").val("");
					  
				  }, 
	    		 error : function(error){
	    			 console.log(error);
	    		 }
	    		  
	    	  }) 
	      }
	      
		</script>
	</div>
	<!-- index.html 고유 스크립트 추가 -->
	<th:block layout:fragment="script">
		<!--    <script th:src="@{/js/page/home.js}"></script>-->
	</th:block>
		
    	
			<script th:src="@{/shoptemplate/js/main.js}"></script>
	
</div>
</html>