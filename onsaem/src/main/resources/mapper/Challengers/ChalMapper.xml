<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.onsaem.web.chal.mapper.ChalMapper">

	<!-- 챌리저스 전체조회 -->
	<select id="getChalAll" resultType="ChalVO">
		SELECT C.CHAL_ID AS CHAL_ID ,
		C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
		ORDER BY CHAL_ID DESC
	</select>

	<!-- 챌리저스 기부처 별전체조회 -->
	<select id="getChalNgoAll" resultType="ChalVO"
		parameterType="String">
		SELECT C.CHAL_ID AS CHAL_ID ,
		C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
		WHERE C.NGO_NAME=#{ngoName}
	</select>

	<!-- 챌리저스 팀전 별전체조회 -->
	<select id="getChalTeamAll" resultType="ChalVO" parameterType="String">
		SELECT C.CHAL_ID AS CHAL_ID ,
		C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
		WHERE C.SUB_CLASS= #{val}
	</select>
	
	<!-- 마이페이지용 - 현재 진행 중인거 모두 리스트 뽑기 , 회원 권한 -일반회원 -->
	<select id="myCurentChal" resultType="ChalVO" >
		SELECT C.CHAL_ID AS CHALID, C.SUB_CLASS AS SUBCLASS, C.FREQUENCY AS FREQUENCY, C.MEMBER_ID AS MEMBERID, C.CHAL_NAME AS CHALNAME, C.START_DATE AS STARTDATE, C.END_DATE AS ENDDATE
		FROM CHALLENGES C JOIN PARTICIPANTS P
		ON C.CHAL_ID = P.CHAL_ID
		WHERE P.PARTICIPANT_ID = #{participantId} 
			AND CURRENT_DATE BETWEEN C.START_DATE AND C.END_DATE
		
	</select>
	
	<select id="myBeforeChal" resultType="ChalVO" parameterType="ChalVO">
		SELECT C.CHAL_ID AS CHALID, C.SUB_CLASS AS SUBCLASS, C.FREQUENCY AS FREQUENCY, C.MEMBER_ID AS MEMBERID
						, C.CHAL_NAME AS CHALNAME, C.START_DATE AS STARTDATE, C.END_DATE AS ENDDATE
                ,P.PRIVATE_DONATE AS PRIVATEDONATE, Y.PAYMENT_ID AS PAYMENTID, Y.PAYMENT_METHOD AS PAYMENTMETHOD
		FROM CHALLENGES C JOIN PARTICIPANTS P
		ON C.CHAL_ID = P.CHAL_ID
        JOIN PAYMENTS Y
        ON P.CHAL_ID = Y.GROUP_ID
		WHERE P.PARTICIPANT_ID = #{participantId}
		AND C.START_DATE > CURRENT_DATE
	</select>
	
	<select id="myEndChal" resultType="ChalVO" parameterType="ChalVO">
		SELECT C.CHAL_ID AS CHALID, C.SUB_CLASS AS SUBCLASS, C.FREQUENCY AS FREQUENCY, C.MEMBER_ID AS MEMBERID
				, C.CHAL_NAME AS CHALNAME, C.START_DATE AS STARTDATE, C.END_DATE AS ENDDATE, P.RESULT AS RESULT, P.RESULT_POINT AS RESULTPOINT, C.RECEIPT AS RECEIPT
		FROM CHALLENGES C JOIN PARTICIPANTS P
		ON C.CHAL_ID = P.CHAL_ID
		WHERE P.PARTICIPANT_ID = #{participantId} 
		AND CURRENT_DATE > C.END_DATE
		ORDER BY C.END_DATE DESC
	</select>
	
	<!-- 챌린지 조회 용들 ㅎ -->
	<select id="currentChals" resultType="ChalVO">
		SELECT C.CHAL_ID AS CHAL_ID ,
		C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
		WHERE  CURRENT_DATE BETWEEN C.START_DATE AND C.END_DATE
		ORDER BY CHAL_ID DESC
	</select>
	
	<select id="beforeChals" resultType="ChalVO">
		SELECT C.CHAL_ID AS CHAL_ID ,
		C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
		WHERE  C.START_DATE > CURRENT_DATE
		ORDER BY CHAL_ID DESC
	</select>
		
	<select id="endChals" resultType="ChalVO">
		SELECT C.CHAL_ID AS CHAL_ID ,
		C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
		WHERE  CURRENT_DATE > C.END_DATE
		ORDER BY C.END_DATE DESC
	</select>
	
	
	<!-- 단건조회 -->
	<select id="getChal" resultType="CHALVO" parameterType="string">
		SELECT *
		FROM CHALLENGES
		WHERE CHAL_ID = #{chalId}
	</select>

	<!-- 챌리저스 등록 -->
	<insert id="inputChal" parameterType="ChalVO">
		<selectKey keyProperty="chalId" resultType="string" order="BEFORE">
			SELECT
			'CH'||LPAD(CHAL_SEQ.NEXTVAL,3,0) FROM DUAL
		</selectKey>
		INSERT into CHALLENGES
		VALUES(#{chalId}, #{classes}, #{subClass}, #{frequency}, #{ngoName}, #{startDate},
		#{endDate}, #{contents}, #{proofContent},
		#{donationFee}, #{memberId}, #{teamFee}, #{chalName}, #{receipt})
	</insert>

	<!-- 수정 -->
	<update id="modifyChal" parameterType="ChalVO">
		UPDATE CHALLENGES
		SET CLASSES = #{classes},
		NGO_NAME = #{ngoName},
		START_DATE = #{startDate},
		END_DATE = #{endDate},
		CONTENTS = #{contents},
		PROOF_CONTENT =
		#{proofContent}
		WHERE CHAL_ID=#{chalId}
	</update>

	<!-- 기부금 업데이트 -->
	<update id="updateDonate" parameterType="ChalVO">
		UPDATE CHALLENGES
		SET DONATION_FEE = #{donationFee}
		WHERE CHAL_ID=#{chalId}
	</update>

	<!-- 챌린저스 취소-개최자만 가능함, 관리자랑 ㅋㅋ -->
	<delete id="delChal" parameterType="String">
		DELETE CHALLENGES
		WHERE CHAL_ID=#{chalId}
	</delete>
	
	<!-- 챌리저스 기부금 순위 조회 3등까지 -->
	<select id="donateRank" resultType="ChalVO">
		SELECT C.CHAL_ID AS CHAL_ID , C.CLASSES AS CLASSES, C.SUB_CLASS AS SUB_CLASS, C.CHAL_NAME AS
		CHAL_NAME, C.START_DATE AS START_DATE, C.END_DATE AS END_DATE, C.DONATION_FEE AS DONATIONFEE,
		M.FILE_ROUTE AS FILE_ROUTE, M.MEDIA_NAME AS MEDIA_NAME, ROWNUM
		FROM CHALLENGES C JOIN MEDIA M
		ON C.CHAL_ID = M.GROUP_ID
        WHERE 3>=ROWNUM
        ORDER BY C.DONATION_FEE DESC
	</select>

	<!-- 관리자가 기부금 영수증 첨부 후 상태 업데이트 -->
	<update id="updateRecipt" parameterType="ChalVO">
		UPDATE CHALLENGES
		SET RECEIPT = #{receipt}
		WHERE CHAL_ID = #{chalId}
	</update>
	
	<!-- 썸네일만 가져오기 -->
	<select id="thumnail" resultType="MediaVO">
		SELECT * 
		FROM MEDIA
		WHERE GROUP_ID = #{GROUPID}
		AND SUB_GROUP = '썸네일'
	</select>
	
	<!-- 인증샷 예시만 가져오기 -->
	<select id="proofEx" resultType="MediaVO">
		SELECT * 
		FROM MEDIA
		WHERE GROUP_ID = #{GROUPID}
		AND SUB_GROUP = '인증예시'	
	</select>

</mapper>